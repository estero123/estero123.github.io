<!DOCTYPE html>
<html lang="pl">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Odbioru Mikroinstalacji</title>
    <!-- Assumes jquery.min.js is in the same folder -->
    <script src="./jquery.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f6f9; color: #333; display: flex; justify-content: center; padding: 20px; box-sizing: border-box; }
        .container { background-color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px 30px; border-radius: 8px; max-width: 800px; width: 100%; }
        
        h2 { text-align: center; color: #344290; margin-top: 0; }

        .form-section { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
        .form-section h3 { margin-top: 0; color: #344290; border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 1.2em; }
        .form-row { display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
        .form-row label { flex: 1 1 60%; padding-right: 15px; font-weight: 500; font-size: 16px; }
        .form-row .input-wrapper { flex: 1 1 40%; }
        input[type="number"], select { width: 100%; padding: 10px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .form-error { color: #dc3545; font-size: 14px; display: none; margin-top: 5px; width: 100%; }
        .form-row.has-error input, .form-row.has-error select { border-color: #dc3545; }
        .form-row.has-error .form-error { display: block; }
        
        .phase-selector { display: flex; gap: 20px; margin-bottom: 20px; }
        .phase-selector label { display: inline-flex; align-items: center; cursor: pointer; font-size: 16px; }
        .phase-selector input[type="radio"] { margin-right: 8px; transform: scale(1.2); }
        
        /* Table Styles */
        #table-wrapper { display: none; margin-top: 25px; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .data-table thead th { background-color: #eef2f7; font-weight: bold; color: #344290; }
        .data-table thead .main-header { background-color: #d8e1f0; font-size: 16px; }

        #Przelicz, #toggle-table-btn { background-color: #344290; color: white; border: none; padding: 12px 25px; font-size: 18px; font-weight: bold; border-radius: 5px; cursor: pointer; display: block; width: 100%; }
        #Przelicz:hover, #toggle-table-btn:hover { background-color: #2a3574; }
        #toggle-table-btn { background-color: #6c757d; margin-top: 15px; font-size: 14px; padding: 10px; }
        #toggle-table-btn:hover { background-color: #5a6268; }

        #Wynik { margin-top: 30px; }
        .result-box { border-radius: 8px; padding: 20px; text-align: center; }
        .result-box h3 { margin-top: 0; font-size: 24px; }
        .result-box p { margin: 8px 0; font-size: 16px; }
        .result-positive { background-color: #e9f5ec; color: #155724; border: 2px solid #28a745; }
        .result-negative { background-color: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .result-details { font-size: 14px; color: #555; border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px; }

        @media (max-width: 600px) {
            .form-row { flex-direction: column; align-items: stretch; }
            .form-row label { margin-bottom: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Kalkulator Odbioru Mikroinstalacji</h2>
        
        <div class="form-section">
            <h3>Parametry instalacji</h3>
            <div class="form-row">
                <label for="panele-ilosc">Ilość paneli OZE [szt]</label>
                <div class="input-wrapper">
                    <input type="number" required="true" id="panele-ilosc" placeholder="np. 20">
                    <div class="form-error">Pole jest obowiązkowe</div>
                </div>
            </div>
             <div class="form-row">
                <label for="panele-moc-jednostkowa">Moc jednostkowa paneli [kW]</label>
                <div class="input-wrapper">
                    <input type="number" required="true" id="panele-moc-jednostkowa" placeholder="np. 0.45">
                    <div class="form-error">Pole jest obowiązkowe</div>
                </div>
            </div>
             <div class="form-row">
                <label for="panele-moc-wynik">Moc paneli (obliczona) [kW]</label>
                <div class="input-wrapper">
                    <input type="number" id="panele-moc-wynik" readonly>
                </div>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <div class="form-row">
                <label for="falownik">Moc falownika (inwertera) [kW]</label>
                <div class="input-wrapper">
                    <input type="number" required="true" id="falownik" placeholder="np. 10">
                    <div class="form-error">Pole jest obowiązkowe</div>
                </div>
            </div>
            <div class="form-row">
                <label for="magazyn">Moc magazynu energii [kW]</label>
                <div class="input-wrapper">
                    <input type="number" required="true" id="magazyn" value="0" placeholder="0 jeśli brak">
                    <div class="form-error">Pole jest obowiązkowe</div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Moc przyłączeniowa (dane z wniosku)</h3>
            <div class="phase-selector">
                <label><input type="radio" name="faza" value="1f" checked> 1-fazowa</label>
                <label><input type="radio" name="faza" value="3f"> 3-fazowa</label>
            </div>
            <div class="form-row">
                <label for="moc-przylaczeniowa">Wybierz moc przyłączeniową [kW]</label>
                <div class="input-wrapper">
                    <select id="moc-przylaczeniowa-1f" class="moc-przylaczeniowa-select" required>
                        <option value="" disabled selected>Wybierz moc...</option>
                    </select>
                    <select id="moc-przylaczeniowa-3f" class="moc-przylaczeniowa-select" required style="display:none;">
                        <option value="" disabled selected>Wybierz moc...</option>
                    </select>
                    <div class="form-error">Wybierz moc przyłączeniową</div>
                </div>
            </div>
        </div>

        <button type="button" id="Przelicz">Sprawdź</button>
        <div id="Wynik"></div>

        <button type="button" id="toggle-table-btn">Pokaż / Ukryj Tabelę Mocy</button>
        <div id="table-wrapper">
             <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th colspan="3" class="main-header">1 Fazowa</th>
                            <th colspan="3" class="main-header">3 fazowa</th>
                        </tr>
                        <tr>
                            <th>Umowna [kW]</th>
                            <th>Przyłączeniowa [kW]</th>
                            <th>Zabezpieczenie [A]</th>
                            <th>Umowna [kW]</th>
                            <th>Przyłączeniowa [kW]</th>
                            <th>Zabezpieczenie [A]</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>0,5</td><td>1,0</td><td>6</td><td>0,5</td><td>3,0</td><td>6</td></tr>
                        <tr><td>1,5</td><td>2,0</td><td>10</td><td>3,5</td><td>6,0</td><td>10</td></tr>
                        <tr><td>2,5</td><td>3,0</td><td>16</td><td>6,5</td><td>10,0</td><td>16</td></tr>
                        <tr><td>3,5</td><td>4,0</td><td>20</td><td>10,5</td><td>12,0</td><td>20</td></tr>
                        <tr><td>4,5</td><td>5,0</td><td>25</td><td>12,5</td><td>16,0</td><td>25</td></tr>
                        <tr><td>5,5</td><td>6,0</td><td>32</td><td>16,5</td><td>20,0</td><td>32</td></tr>
                        <tr><td></td><td></td><td></td><td>20,5</td><td>25,0</td><td>40</td></tr>
                        <tr><td></td><td></td><td></td><td>25,5</td><td>32,0</td><td>50</td></tr>
                        <tr><td></td><td></td><td></td><td>32,5</td><td>40,0</td><td>63</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            'use strict';
            
            // --- GENERATE DROPDOWN OPTIONS ---
            function generatePowerOptions(selectElement, start, end, step) {
                for (let i = start; i <= end; i += step) {
                    let value = i.toFixed(1);
                    selectElement.append(`<option value="${value}">${value} kW</option>`);
                }
            }
            generatePowerOptions($('#moc-przylaczeniowa-1f'), 0.5, 6.0, 0.5);
            generatePowerOptions($('#moc-przylaczeniowa-3f'), 0.5, 40.0, 0.5);

            // --- EVENT HANDLERS ---
            $('input[name="faza"]').on('change', function() {
                $('.moc-przylaczeniowa-select').hide().val('');
                $('#Wynik').html('');
                if (this.value === '1f') {
                    $('#moc-przylaczeniowa-1f').show();
                } else {
                    $('#moc-przylaczeniowa-3f').show();
                }
            });

            $('.moc-przylaczeniowa-select').on('change', function() {
                 if ($(this).val()) {
                    $(this).closest('.form-row').removeClass('has-error');
                 }
            });

            $('#toggle-table-btn').on('click', function() {
                $('#table-wrapper').slideToggle();
            });

            // --- MAIN CALCULATION ON CLICK ---
            $('#Przelicz').on('click', function() {
                if (!validateForm()) {
                    $('#Wynik').html('').hide();
                    return;
                }
                
                const iloscPaneli = parseFloat($('#panele-ilosc').val());
                const mocJednostkowa = parseFloat($('#panele-moc-jednostkowa').val());
                const panele = iloscPaneli * mocJednostkowa;
                
                // Update the read-only field
                $('#panele-moc-wynik').val(panele.toFixed(2));

                const falownik = parseFloat($('#falownik').val());
                const magazyn = parseFloat($('#magazyn').val());
                const mocPrzylaczeniowa = parseFloat($('.moc-przylaczeniowa-select:visible').val());

                let mocMikroinstalacji = 0;

                // Implement the calculation logic
                if (magazyn == 0) {
                    mocMikroinstalacji = panele;
                } else {
                    if (falownik > panele) {
                        mocMikroinstalacji = panele + magazyn;
                    } else { // falownik <= panele
                        if (magazyn <= panele) {
                            mocMikroinstalacji = panele;
                        } else { // magazyn > panele
                            mocMikroinstalacji = panele + magazyn;
                        }
                    }
                }
                
                // Perform the final condition check and generate result
                let resultHTML;
                if (mocMikroinstalacji <= mocPrzylaczeniowa) {
                    resultHTML = `
                        <div class="result-box result-positive">
                            <h3>Odbiór Pozytywny</h3>
                            <p>Moc mikroinstalacji (${mocMikroinstalacji.toFixed(2)} kW) nie przekracza mocy przyłączeniowej (${mocPrzylaczeniowa.toFixed(2)} kW).</p>
                        </div>
                    `;
                } else {
                    resultHTML = `
                        <div class="result-box result-negative">
                            <h3>Odbiór Negatywny</h3>
                            <p>Moc mikroinstalacji (${mocMikroinstalacji.toFixed(2)} kW) przekracza moc przyłączeniową (${mocPrzylaczeniowa.toFixed(2)} kW).</p>
                            <p class="result-details">Konieczna poprawa wniosku o przyłączenie.</p>
                        </div>
                    `;
                }
                
                $('#Wynik').html(resultHTML).show();
            });

            function validateForm() {
                let isValid = true;
                $('.form-row.has-error').removeClass('has-error');
                
                $('#panele-ilosc, #panele-moc-jednostkowa, #falownik, #magazyn').each(function() {
                    if ($(this).val() === '') {
                        isValid = false;
                        $(this).closest('.form-row').addClass('has-error');
                    }
                });

                const activeSelect = $('.moc-przylaczeniowa-select:visible');
                if (!activeSelect.val()) {
                    isValid = false;
                    activeSelect.closest('.form-row').addClass('has-error');
                }
                return isValid;
            }
        });
    </script>
</body>
</html>
